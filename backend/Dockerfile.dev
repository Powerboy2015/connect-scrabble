# Development Dockerfile
FROM golang:1.25

WORKDIR /app

# Copy mod files and download dependencies (cached between builds)
COPY ./src/go.mod ./src/go.sum ./
RUN go mod download

# Copy application sources
COPY ./src .

# Build once to produce an initial binary (optional)
RUN go build -o /server ./

# Install CompileDaemon for reliable polling-based rebuilds inside containers
RUN go install github.com/githubnemo/CompileDaemon@latest

# Expose the HTTP port
EXPOSE 8081

# Use CompileDaemon to watch for changes and rebuild with polling (works well on WSL/Windows mounts)
# -build flag ensures the binary is rebuilt with the given command; -poll enables polling
CMD ["CompileDaemon", "-command", "/server", "-directory", "/app", "-polling", "-polling-interval", "200", "-build=go build -o /server ./"]